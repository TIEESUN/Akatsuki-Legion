"""
Malware Bazaar API integration

Implements comprehensive malware sample lookup, detection queries, and analysis using Malware Bazaar v1 API.
"""

import logging
from typing import Dict, Any, List
from .base import BaseAPIClient

logger = logging.getLogger(__name__)


class MalwareBazaarAPI(BaseAPIClient):
    """Malware Bazaar API client"""

    BASE_URL = "https://mb-api.abuse.ch/api/v1/"

    def __init__(self, api_key: str):
        """Initialize with Auth-Key"""
        super().__init__(api_key)
        self.headers = {"Auth-Key": self.api_key}

    def analyze(self, observable: str) -> Dict[str, Any]:
        """
        Analyze an observable (file hash, tag, signature, etc).
        Returns a consolidated dict with raw_data included.
        """
        # Try as hash first (SHA256, MD5, SHA1)
        hash_result = self._query_hash(observable)
        if hash_result and hash_result.get("query_status") == "ok":
            return hash_result
        
        # Try as tag
        tag_result = self._query_tag(observable)
        if tag_result and tag_result.get("query_status") == "ok" and tag_result.get("data"):
            return tag_result
        
        # Try as signature/malware family
        sig_result = self._query_signature(observable)
        if sig_result and sig_result.get("query_status") == "ok" and sig_result.get("data"):
            return sig_result
        
        # Return hash result as primary (or error if no results)
        return hash_result if hash_result else {"error": "No results found for observable"}

    def _query_hash(self, file_hash: str) -> Dict[str, Any]:
        """Query malware sample by hash (SHA256, MD5, SHA1)"""
        result = {"source": "Malware Bazaar", "type": "hash", "observable": file_hash}
        raw = {}

        data = {
            "query": "get_info",
            "hash": file_hash
        }

        response = self._make_request(self.BASE_URL, method="POST", data=data, headers=self.headers)
        raw["hash_query"] = response

        if isinstance(response, dict):
            query_status = response.get("query_status", "")
            
            # Success case
            if query_status == "ok" and "data" in response:
                data = response["data"]
                
                # Handle list response (API returns array for hash queries)
                if isinstance(data, list):
                    if len(data) > 0 and isinstance(data[0], dict):
                        sample_data = data[0]
                    else:
                        result.update({
                            "query_status": query_status,
                            "error": "No samples found"
                        })
                        return result
                # Handle dict response
                elif isinstance(data, dict):
                    sample_data = data
                else:
                    logger.warning(f"Unexpected data type from Malware Bazaar: {type(data)}")
                    result.update({
                        "query_status": query_status,
                        "error": f"Unexpected data format: {type(data).__name__}",
                        "raw_response": response
                    })
                    return result
                
                # Extract sample data
                result.update({
                    "query_status": "ok",
                    "file_name": sample_data.get("file_name"),
                    "file_size": sample_data.get("file_size"),
                    "file_type": sample_data.get("file_type"),
                    "file_format": sample_data.get("file_format"),
                    "file_arch": sample_data.get("file_arch"),
                    "file_type_mime": sample_data.get("file_type_mime"),
                    "sha256": sample_data.get("sha256_hash"),
                    "sha1": sample_data.get("sha1_hash"),
                    "md5": sample_data.get("md5_hash"),
                    "sha3_384": sample_data.get("sha3_384_hash"),
                    "first_seen": sample_data.get("first_seen"),
                    "last_seen": sample_data.get("last_seen"),
                    "reporter": sample_data.get("reporter"),
                    "signature": sample_data.get("signature"),  # Malware family
                    "tags": sample_data.get("tags", []),
                    "imphash": sample_data.get("imphash"),
                    "tlsh": sample_data.get("tlsh"),
                    "telfhash": sample_data.get("telfhash"),
                    "gimphash": sample_data.get("gimphash"),
                    "ssdeep": sample_data.get("ssdeep"),
                    "magika": sample_data.get("magika"),
                    "dhash_icon": sample_data.get("dhash_icon"),
                    "trid": sample_data.get("trid"),
                    "code_sign": sample_data.get("code_sign"),
                    "delivery_method": sample_data.get("delivery_method"),
                    "intelligence": sample_data.get("intelligence", {}),
                    "downloads": sample_data.get("downloads"),
                    "uploads": sample_data.get("uploads"),
                    "comments": sample_data.get("comments", []),
                    "yara_rules": sample_data.get("yara_rules", []),
                    "vendor_intel": sample_data.get("vendor_intel", {}),
                })
            else:
                # Error cases
                result.update({
                    "query_status": query_status,
                    "error": query_status if query_status else "Unknown error",
                    "raw_response": response
                })
        else:
            result.update({
                "error": "Invalid response format from API",
                "raw_response": response
            })

        result["raw_data"] = raw
        return result

    def _query_tag(self, tag: str, limit: int = 100) -> Dict[str, Any]:
        """Query malware samples by tag"""
        result = {"source": "Malware Bazaar", "type": "tag_query", "observable": tag}
        raw = {}

        data = {
            "query": "get_taginfo",
            "tag": tag,
            "limit": limit
        }

        response = self._make_request(self.BASE_URL, method="POST", data=data, headers=self.headers)
        raw["tag_query"] = response

        if isinstance(response, dict):
            query_status = response.get("query_status", "")
            
            if query_status == "ok" and "data" in response:
                samples = response["data"]
                # Ensure samples is a list
                if isinstance(samples, list):
                    result.update({
                        "query_status": "ok",
                        "tag": tag,
                        "sample_count": len(samples),
                        "samples": samples
                    })
                else:
                    result.update({
                        "query_status": "ok",
                        "tag": tag,
                        "sample_count": 0,
                        "samples": []
                    })
            else:
                result.update({
                    "query_status": query_status,
                    "error": query_status if query_status else "Unknown error"
                })

        result["raw_data"] = raw
        return result

    def _query_signature(self, signature: str, limit: int = 100) -> Dict[str, Any]:
        """Query malware samples by signature/family"""
        result = {"source": "Malware Bazaar", "type": "signature_query", "observable": signature}
        raw = {}

        data = {
            "query": "get_siginfo",
            "signature": signature,
            "limit": limit
        }

        response = self._make_request(self.BASE_URL, method="POST", data=data, headers=self.headers)
        raw["signature_query"] = response

        if isinstance(response, dict):
            query_status = response.get("query_status", "")
            
            if query_status == "ok" and "data" in response:
                samples = response["data"]
                # Ensure samples is a list
                if isinstance(samples, list):
                    result.update({
                        "query_status": "ok",
                        "signature": signature,
                        "sample_count": len(samples),
                        "samples": samples
                    })
                else:
                    result.update({
                        "query_status": "ok",
                        "signature": signature,
                        "sample_count": 0,
                        "samples": []
                    })
            else:
                result.update({
                    "query_status": query_status,
                    "error": query_status if query_status else "Unknown error"
                })

        result["raw_data"] = raw
        return result

    def get_recent_detections(self, hours: int = 48) -> Dict[str, Any]:
        """Get recent malware detections from past X hours"""
        result = {"source": "Malware Bazaar", "type": "recent_detections"}
        raw = {}

        data = {
            "query": "recent_detections",
            "hours": min(hours, 168)  # Max 168 hours (7 days)
        }

        response = self._make_request(self.BASE_URL, method="POST", data=data, headers=self.headers)
        raw["recent_detections"] = response

        if isinstance(response, dict):
            query_status = response.get("query_status", "")
            
            if query_status == "ok" and "data" in response:
                detections = response["data"]
                # Ensure detections is a list
                if isinstance(detections, list):
                    result.update({
                        "query_status": "ok",
                        "hours": hours,
                        "detection_count": len(detections),
                        "detections": detections
                    })
                else:
                    result.update({
                        "query_status": "ok",
                        "hours": hours,
                        "detection_count": 0,
                        "detections": []
                    })
            else:
                result.update({
                    "query_status": query_status,
                    "error": query_status if query_status else "Unknown error"
                })

        result["raw_data"] = raw
        return result

    def get_recent_samples(self, limit: int = 100) -> Dict[str, Any]:
        """Get recently added malware samples"""
        result = {"source": "Malware Bazaar", "type": "recent_samples"}
        raw = {}

        data = {
            "query": "get_recent",
            "selector": limit
        }

        response = self._make_request(self.BASE_URL, method="POST", data=data, headers=self.headers)
        raw["recent_samples"] = response

        if isinstance(response, dict):
            query_status = response.get("query_status", "")
            
            if query_status == "ok" and "data" in response:
                samples = response["data"]
                # Ensure samples is a list
                if isinstance(samples, list):
                    result.update({
                        "query_status": "ok",
                        "limit": limit,
                        "sample_count": len(samples),
                        "samples": samples
                    })
                else:
                    result.update({
                        "query_status": "ok",
                        "limit": limit,
                        "sample_count": 0,
                        "samples": []
                    })
            else:
                result.update({
                    "query_status": query_status,
                    "error": query_status if query_status else "Unknown error"
                })

        result["raw_data"] = raw
        return result
